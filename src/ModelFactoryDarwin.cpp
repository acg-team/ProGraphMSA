#include <iostream>
#include <sstream>
#include <cmath>
#include "ModelFactoryDarwin.h"
#include "debug.h"
#include <Eigen/Dense>


ModelFactoryDarwin::ModelFactoryDarwin() {
   static double data[] = {
	   -1.0973752901364022,
	   0.029179756904552125,
	   0.04014974095162329,
	   0.079846843089017377,
	   0.012500487377550275,
	   0.11055517775524745,
	   0.014306527669670768,
	   0.017854780790807927,
	   0.04804250186495667,
	   0.054789828041430032,
	   0.026452742411057675,
	   0.02650504464903021,
	   0.060017442607296141,
	   0.043440746074082472,
	   0.035734130466290599,
	   0.22663933106874673,
	   0.10991373972280209,
	   0.1508720248947634,
	   0.0018078508944589075,
	   0.0087665929030180251,
	   0.12159201229419707,
	   -0.54173362185089646,
	   0.0031936313314983806,
	   0.0015628900805323505,
	   0.02586958592451934,
	   0.022072792635442842,
	   0.0143701795026797,
	   0.015934426927410913,
	   0.0025994823187597193,
	   0.033063558612949823,
	   0.015791776200502487,
	   0.017550075413616032,
	   0.0020629742608328934,
	   0.0050014367586591777,
	   0.020087118898500587,
	   0.085122045541801167,
	   0.042514032505956874,
	   0.080166204889732182,
	   0.007448521398232477,
	   0.025730876355072388,
	   0.058722381672024829,
	   0.0011209398732018347,
	   -0.94783483243250632,
	   0.30579704943677094,
	   0.0019642455542257758,
	   0.06548535650945797,
	   0.026769346071305856,
	   0.0023551260662751689,
	   0.052588066841040004,
	   0.0026662687650617213,
	   0.0011617869313259544,
	   0.18204295423218816,
	   0.02436220195202924,
	   0.050579626860079448,
	   0.019150919795551374,
	   0.081057181338871132,
	   0.060609163677647307,
	   0.0026797520639920362,
	   0.00021738859168714278,
	   0.0085050761997707246,
	   0.10742299041970593,
	   0.00050459686303818384,
	   0.28128842717588548,
	   -1.104523051802903,
	   0.0022306083787217369,
	   0.030673533171936298,
	   0.027085017274099319,
	   0.010957333233833648,
	   0.14803609974177942,
	   0.016958739206079841,
	   0.009750583223515465,
	   0.050371675677981759,
	   0.031323975879687535,
	   0.18054276473680822,
	   0.042008591075520033,
	   0.069261473518259592,
	   0.05118246484117818,
	   0.037256039920735409,
	   0.001441969198243825,
	   0.0062261682658932369,
	   0.024085448911292197,
	   0.011961727381733562,
	   0.002587632899951784,
	   0.003194564348275536,
	   -0.77025955481485009,
	   0.0043669177142043585,
	   0.020546768867674398,
	   0.066204396922661196,
	   0.00544108396917313,
	   0.22019269414208809,
	   0.051277843608492496,
	   0.010168363323829291,
	   0.0049887873695953046,
	   0.0087415592103206093,
	   0.0040504028118905694,
	   0.0093742379282853311,
	   0.020341137093525655,
	   0.046397148130887453,
	   0.033445126150244746,
	   0.2228937140307243,
	   0.11810665354313861,
	   0.0056588630534721582,
	   0.047832002090017811,
	   0.024356764263170995,
	   0.0024212659039645622,
	   -0.4765641818791107,
	   0.0091269960085583659,
	   0.001936228777474245,
	   0.023782956730845919,
	   0.0072923292756566782,
	   0.0039172361104329746,
	   0.055205137069865635,
	   0.01472431750917266,
	   0.019556373047655309,
	   0.03011248384404144,
	   0.080616530806515083,
	   0.017795243146574036,
	   0.0076843052373733681,
	   0.0028890513551771161,
	   0.0035494441060036682,
	   0.047768397025841104,
	   0.011514504274241029,
	   0.061111546895162704,
	   0.067219620714382894,
	   0.035605916160299789,
	   0.028525877454129149,
	   -1.0489104147594837,
	   0.016805793313983637,
	   0.081099842088010923,
	   0.033987887570683314,
	   0.017436158871466764,
	   0.13357868537248249,
	   0.023917588977800313,
	   0.14004166455757366,
	   0.080384333040151648,
	   0.057104572922841421,
	   0.065371839899795489,
	   0.015237606927688102,
	   0.0067311539660281881,
	   0.12546742472692096,
	   0.0241619737541298,
	   0.0051747688853396876,
	   0.0021790697455291628,
	   0.011021565026871483,
	   0.046498283400562321,
	   0.0024526709044018157,
	   0.0068113073100240212,
	   -1.2167353711758992,
	   0.022023721217983079,
	   0.35457462759430824,
	   0.10427169113444335,
	   0.012751156130696219,
	   0.0080465698976806034,
	   0.0097601401567125219,
	   0.01072024624212208,
	   0.014119312558823486,
	   0.056391228228395845,
	   0.50819562279724129,
	   0.0038185849558579816,
	   0.013762831234776205,
	   0.064143719563962073,
	   0.00083289837710281197,
	   0.048005922187376031,
	   0.14691179698216864,
	   0.0037703889449003636,
	   0.029723441553081362,
	   0.032429638267975049,
	   0.021729080049370433,
	   -1.1681438198475855,
	   0.034530231659649586,
	   0.019524533250119883,
	   0.097933913758240149,
	   0.030236936887246265,
	   0.14454858840001683,
	   0.29796115639786802,
	   0.066132489209983922,
	   0.090728144604303257,
	   0.026787664456663141,
	   0.0011196253882971019,
	   0.011093649909260957,
	   0.045607812502088299,
	   0.006604889000188025,
	   0.0015174776951785453,
	   0.010492847930902535,
	   0.095129324109300112,
	   0.0056821186550617695,
	   0.0084733871432918165,
	   0.21810673420759627,
	   0.021528326565562673,
	   -0.810545492672053,
	   0.11743754373079292,
	   0.0075983945668966829,
	   0.018894852085456281,
	   0.030160574510201304,
	   0.020909567298583395,
	   0.016029287647360328,
	   0.024621946682195927,
	   0.13647971533576322,
	   0.0067686556660982731,
	   0.018502037339534715,
	   0.091090402534078699,
	   0.01304997027663205,
	   0.0027353159083370947,
	   0.024957037056338744,
	   0.091643965358241666,
	   0.012626599068205792,
	   0.017982344237710789,
	   0.26533250052967972,
	   0.050356328074531213,
	   0.48581349252349754,
	   -1.4143992655349229,
	   0.013163122315531418,
	   0.0034527961458100357,
	   0.062711618798714272,
	   0.019795200846672675,
	   0.0407514713414001,
	   0.07299262812875483,
	   0.12165213383723926,
	   0.0067545848300999429,
	   0.017537753723446695,
	   0.045710176902247705,
	   0.0072634001802425819,
	   0.21465317798862618,
	   0.064570072259771613,
	   0.0091013877691241089,
	   0.089118645544600528,
	   0.068994599536564366,
	   0.016250100068023049,
	   0.12649954052708176,
	   0.015742253383737085,
	   0.0065923667531782321,
	   -1.1159105456599441,
	   0.017830781457067447,
	   0.068762635902958724,
	   0.049393934531713375,
	   0.16919888401529934,
	   0.10821523436170795,
	   0.013095846580175031,
	   0.0018962661522367726,
	   0.023021241745588322,
	   0.10335226631239613,
	   0.0008525364406673728,
	   0.028683896285443173,
	   0.040094048501269269,
	   0.0044587149987877573,
	   0.023734627229192496,
	   0.012335407133771761,
	   0.010239421503323434,
	   0.038998848802476449,
	   0.039088293423974955,
	   0.0017266787265722739,
	   0.017804448823841534,
	   -0.57192217199010631,
	   0.040599684835700159,
	   0.025882992584352126,
	   0.083100015202492661,
	   0.069354000525388856,
	   0.023795919916842594,
	   0.00080077376455300441,
	   0.0070195969790602785,
	   0.090489135911783189,
	   0.0025001759367088002,
	   0.072036710496641371,
	   0.27953730025277024,
	   0.0094506193246193856,
	   0.038132229803068712,
	   0.087367518621485299,
	   0.015023714924365755,
	   0.22551970567156687,
	   0.07547436544956726,
	   0.037935451635771979,
	   0.083055294036129559,
	   0.049111060177446451,
	   -1.4380975174179187,
	   0.16104396047647701,
	   0.087275842347259547,
	   0.078587691630059242,
	   0.027927880388379688,
	   0.0050718907059762479,
	   0.012556969627842227,
	   0.052576542345949696,
	   0.007092560953180436,
	   0.019265377641650473,
	   0.045941739089016054,
	   0.0030929950114183436,
	   0.041472489501474037,
	   0.035422057771663969,
	   0.011655628010383114,
	   0.32835219935014387,
	   0.03695851760318275,
	   0.0084579827918115202,
	   0.04214034267532954,
	   0.022114685750941776,
	   0.11375070047616136,
	   -0.92475938084335318,
	   0.054564690208294249,
	   0.053225572164704596,
	   0.023199473077810621,
	   0.0092185036709088938,
	   0.016257322749327854,
	   0.29461070663352412,
	   0.026554120464650961,
	   0.072041679642280157,
	   0.066921471976054553,
	   0.0063244304203338196,
	   0.098093916397411746,
	   0.02223195758801759,
	   0.013562786106556819,
	   0.064387207700263557,
	   0.025031574240920833,
	   0.0153834810686153,
	   0.12753411664908115,
	   0.062729500715157899,
	   0.054463823859568168,
	   0.048207669500311544,
	   -1.3785345028933571,
	   0.33044214446154097,
	   0.02537515765513779,
	   0.0037930145307731437,
	   0.02084574328315731,
	   0.13985064102942546,
	   0.012981396066816532,
	   0.052726610544241631,
	   0.048405441496736021,
	   0.013432594490820106,
	   0.021194399978634922,
	   0.024911320916461727,
	   0.053020783966058936,
	   0.086462140286094877,
	   0.037635315239188123,
	   0.026970534869182886,
	   0.07983926297869437,
	   0.051243817485621942,
	   0.048002940699992738,
	   0.046028202223131282,
	   0.32344069580074813,
	   -1.2142476544341883,
	   0.1355307555678332,
	   0.0017577296556425864,
	   0.010813071138862968,
	   0.1709972458934608,
	   0.021804611063080282,
	   0.0020766059624569848,
	   0.03138611768382582,
	   0.027292535506577512,
	   0.008152479717937736,
	   0.0051723836954330601,
	   0.42563117586279148,
	   0.022739804272303557,
	   0.18582716413791317,
	   0.040040381728370163,
	   0.0086065602464118172,
	   0.015661753224388432,
	   0.015195647363468441,
	   0.017871035375401533,
	   0.022124624042219383,
	   0.1207273809530448,
	   -1.1597753225910421,
	   0.0017911543161471121,
	   0.016676661545810163,
	   0.010860564708174172,
	   0.010738323725459548,
	   0.00089290577983703191,
	   0.0064388201529391323,
	   0.10427851505946954,
	   0.016246124751512006,
	   0.012110801750897736,
	   0.01695174343222244,
	   0.0050377198486214201,
	   0.048848689287717496,
	   0.011783831967864306,
	   0.0066054852976646806,
	   0.0027935542952239006,
	   0.014627177102389045,
	   0.037639290555699159,
	   0.017529158155451682,
	   0.0082990695142825064,
	   0.009493850891676996,
	   -0.440877200928038,
	   0.099701574650935168,
	   0.021017498393893431,
	   0.014804078687130535,
	   0.013941435004233829,
	   0.011095108382325808,
	   0.27734491319692911,
	   0.007965540459005856,
	   0.090089616602423178,
	   0.024382603820492784,
	   0.019920311036845086,
	   0.053288124001426691,
	   0.012210184663673853,
	   0.032003285572165509,
	   0.0097728187278395603,
	   0.014452263175903075,
	   0.02649051540047425,
	   0.038446279807441232,
	   0.020374490948231943,
	   0.035275964889883077,
	   0.039788942959046593,
	   -0.76266397572936551};

   this->Q = Eigen::Map<Model<AA>::Subst>(data);

   Eigen::EigenSolver<Model<AA>::Subst> solver2(this->Q.transpose());
   Model<AA>::Freqs sigma2 = solver2.eigenvalues().real();
   Model<AA>::Subst V2 = solver2.eigenvectors().real();

   Model<AA>::Freqs::Index izero;
   sigma2.maxCoeff(&izero);
   assert(std::abs(sigma2(izero)) < 1e-8 && "Invalid Q-Matrix");

   this->freqs = V2.col(izero)/V2.col(izero).sum();

   // normalize rate
   this->Q.diagonal().setZero();
   this->Q.diagonal() = -this->Q.rowwise().sum().eval();
   this->Q /= -(this->freqs.transpose() * this->Q.diagonal())(0,0);

   Eigen::EigenSolver<Model<AA>::Subst> solver(this->Q);
   this->sigma = solver.eigenvalues().real();
   this->V = solver.eigenvectors().real();
   this->Vi = this->V.inverse();
}

double ModelFactoryDarwin::getEpsilon(distance_t distance) const
{
	(void)distance;
	return 0.72508680168437312;
}

double ModelFactoryDarwin::getDelta(distance_t distance) const
{
	//	return std::min(0.019213408195977926 * std::pow(model.distance,0.7434),0.3);
		return std::min(0.5,0.0052820194976999644 * std::pow(distance,0.7434));
}
